<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inspektion – Ärendechatt</title>
  <style>
    :root { --radius: 14px; --pad: 14px; --max: 760px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0c0f; color:#e8eaed; margin:0; }
    .wrap { max-width:var(--max); margin:0 auto; padding:24px 16px 64px; }
    h1 { font-size:20px; margin:0 0 16px; color:#e8eaed; }
    form { display:grid; gap:12px; background:#111318; border:1px solid #1f2329; padding:16px; border-radius:var(--radius); }
    .row { display:grid; gap:8px; }
    label { font-size:12px; color:#c7cbd1; letter-spacing:.2px; }
    input[type="text"] { padding:12px; border-radius:10px; border:1px solid #2a2f37; background:#0f1116; color:#e8eaed; outline:none; }
    .radios { display:flex; gap:12px; flex-wrap:wrap; }
    .radio { background:#0f1116; border:1px solid #2a2f37; padding:10px 12px; border-radius:999px; display:flex; align-items:center; gap:8px; cursor:pointer; }
    .radio input { accent-color:#6ea8fe; }
    button { padding:12px 16px; border-radius:999px; border:1px solid #2a2f37; background:#1a73e8; color:white; font-weight:600; cursor:pointer; }
    button[disabled]{ opacity:.7; cursor:not-allowed;}
    .chat { margin-top:16px; display:grid; gap:10px; }
    .msg { max-width:70%; padding:12px; border-radius:14px; border:1px solid #232833; line-height:1.35; }
    .me { justify-self:flex-end; background:#16335b; }
    .sys { justify-self:flex-start; background:#141821; }
    .meta { font-size:12px; color:#a9b0bb; margin-top:2px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #2a2f37; border-radius:999px; font-size:11px; color:#c7cbd1; }
    .hint { margin-top:12px; font-size:12px; color:#a9b0bb; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Inspektion – Ärendechatt</h1>
    <form id="f">
      <div class="row">
        <label for="reg">Registreringsnummer</label>
        <input id="reg" name="regnr" type="text" required placeholder="ABC123" autocomplete="off" />
      </div>
      <div class="row">
        <label>Skick</label>
        <div class="radios">
          <label class="radio">
            <input type="radio" name="skick" value="inspektion genomförd utan anmärkning." required />
            inspektion genomförd utan anmärkning.
          </label>
          <label class="radio">
            <input type="radio" name="skick" value="Inspektion behöver granskas." required />
            Inspektion behöver granskas.
          </label>
        </div>
      </div>
      <button type="submit">Skicka in</button>
      <div class="hint">Uppdateringar visas nedan. Länk öppnas i Teams-kortet.</div>
    </form>

    <div id="chat" class="chat"></div>
  </div>

  <script>
    // ==== KONFIGURATION: Byt till dina värden ====
    const FLOW_URL = "https://prod-97.westus.logic.azure.com:443/workflows/a248bd2c1a01408a960434d68b147fa2/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Gfa03ZUPEmaIwzRQT0ArcGKaocNrGLmQNnyD6NIEb8c";
    const GH_OWNER = "esjobergs";    // t.ex. your-org eller ditt användarnamn
    const GH_REPO  = "gire-chat";            // måste matcha repo-namnet
    // ============================================

    const f = document.getElementById('f');
    const chat = document.getElementById('chat');
    let pollTimer = null;

    f.addEventListener('submit', async (e) => {
      e.preventDefault();
      const reg = (document.getElementById('reg').value || '').trim();
      const skick = (new FormData(f)).get('skick');
      if(!reg || !skick) return;

      const btn = f.querySelector('button');
      btn.disabled = true;

      // Skicka till Power Automate (no-cors för att undvika preflight)
      try {
        await fetch(FLOW_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ regnr: reg, skick })
        });
      } catch(e) { /* tyst – vi kan ändå läsa status via GitHub */ }

      // Visa första rad lokalt och starta polling mot GitHub Issues
      chat.innerHTML = '';
      addMsg(`Skickat: ${reg} – ${skick}`, 'me');
      startPolling(reg);
      btn.disabled = false;
    });

    function addMsg(txt, who='sys', meta='') {
      const d = document.createElement('div');
      d.className = `msg ${who==='me'?'me':'sys'}`;
      d.innerHTML = txt.replace(/\n/g,'<br/>');
      chat.appendChild(d);
      if(meta){
        const m = document.createElement('div');
        m.className = 'meta';
        m.textContent = meta;
        chat.appendChild(m);
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function startPolling(reg) {
      if(pollTimer) clearInterval(pollTimer);
      fetchAndRender(reg); // direkt
      pollTimer = setInterval(() => fetchAndRender(reg), 10000); // var 10:e sekund
    }

    async function fetchAndRender(reg) {
      // 1) Hitta issue via sök i titel
      const q = encodeURIComponent(`repo:${GH_OWNER}/${GH_REPO} "${reg}" in:title state:open type:issue`);
      const url = `https://api.github.com/search/issues?q=${q}&per_page=1`;
      const r = await fetch(url);
      if(!r.ok) return;
      const data = await r.json();
      if(!data.items || !data.items.length) return;

      const issue = data.items[0];
      const number = issue.number;

      // Töm och rendera
      chat.innerHTML = '';
      addMsg(`Ärende öppnat för <span class="pill">${reg}</span>`, 'sys');
      if(issue.body){
        addMsg(issue.body, 'sys', `Issue #${number}`);
      }

      // 2) Hämta kommentarer
      const rc = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${number}/comments`);
      if(!rc.ok) return;
      const comments = await rc.json();
      for(const c of comments){
        const who = 'sys'; // alla kommer från automatiska uppdateringar
        addMsg(c.body || '', who, new Date(c.created_at).toLocaleString());
      }
    }
  </script>
</body>
</html>
