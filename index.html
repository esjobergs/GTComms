<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inspektion – Ärendechatt</title>
  <style>
    :root {
      --radius: 14px; --pad: 14px; --max: 760px;
      --bg: #f3f4f6; --text: #111827; --muted: #6b7280;
      --card: #ffffff; --border: #e5e7eb; --input: #ffffff; --input-border: #d1d5db;
      --btn: #2563eb; --btn-text: #ffffff; --btn-border: #1e40af;
      --chip: #4b5563; --chip-border: #d1d5db;
      --bubble-sys: #ffffff; --bubble-me: #e0f2fe; --bubble-border: #e5e7eb; --accent: #2563eb;
    }
    html, body { height: 100%; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    .wrap { max-width: var(--max); margin: 0 auto; padding: 24px 16px 64px; }
    h1 { font-size: 20px; margin: 0 0 16px; color: var(--text); }
    form { display: grid; gap: 12px; background: var(--card); border: 1px solid var(--border); padding: 16px; border-radius: var(--radius); box-shadow: 0 1px 2px rgb(0 0 0 / 4%); }
    .row { display: grid; gap: 8px; }
    label { font-size: 12px; color: var(--muted); letter-spacing: .2px; }
    input[type="text"] { padding: 12px; border-radius: 10px; border: 1px solid var(--input-border); background: var(--input); color: var(--text); outline: none; }
    input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgb(37 99 235 / 15%); }
    .radios { display: flex; gap: 12px; flex-wrap: wrap; }
    .radio { background: var(--input); border: 1px solid var(--input-border); padding: 10px 12px; border-radius: 999px; display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .radio input { accent-color: var(--accent); }
    button { padding: 12px 16px; border-radius: 999px; border: 1px solid var(--btn-border); background: var(--btn); color: var(--btn-text); font-weight: 600; cursor: pointer; box-shadow: 0 1px 2px rgb(0 0 0 / 8%); }
    button[disabled]{ opacity:.7; cursor:not-allowed;}
    .chat { margin-top:16px; display:grid; gap:10px; }
    .msg { max-width: 70%; padding: 12px; border-radius: 14px; border: 1px solid var(--bubble-border); line-height: 1.35; background: var(--bubble-sys); }
    .me { justify-self: flex-end; background: var(--bubble-me); }
    .sys { justify-self: flex-start; background: var(--bubble-sys); }
    .meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .pill { display: inline-block; padding: 2px 8px; border: 1px solid var(--chip-border); border-radius: 999px; font-size: 11px; color: var(--chip); background: #f9fafb; }
    .hint { margin-top:12px; font-size:12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Inspektion – Ärendechatt</h1>
    <form id="f">
      <div class="row">
        <label for="reg">Registreringsnummer</label>
        <input id="reg" name="regnr" type="text" required placeholder="ABC123" autocomplete="off" />
      </div>
      <div class="row">
        <label>Skick</label>
        <div class="radios">
          <label class="radio">
            <input type="radio" name="skick" value="inspektion genomförd utan anmärkning." required />
            inspektion genomförd utan anmärkning.
          </label>
          <label class="radio">
            <input type="radio" name="skick" value="Inspektion behöver granskas." required />
            Inspektion behöver granskas.
          </label>
        </div>
      </div>
      <button type="submit">Skicka in</button>
      <div class="hint">Uppdateringar visas nedan. Länken öppnas i Teams-kortet.</div>
    </form>

    <div id="chat" class="chat"></div>
  </div>

  <script>
    // ===== KONFIG =====
    const FLOW_URL = "https://prod-97.westus.logic.azure.com:443/workflows/a248bd2c1a01408a960434d68b147fa2/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Gfa03ZUPEmaIwzRQT0ArcGKaocNrGLmQNnyD6NIEb8c";
    const GH_OWNER = "esjobergs"; // <-- BYT DETT
    const GH_REPO  = "gire-chat";               // byt om repo heter annat
    // ===================

    const f = document.getElementById('f');
    const chat = document.getElementById('chat');
    let pollTimer = null;

    // Skicka alltid POST – först via Beacon (ingen preflight), sedan fetch (fallback)
    async function sendToFlow(payload){
      try {
        const blob = new Blob([JSON.stringify(payload)], { type: 'text/plain;charset=UTF-8' });
        const ok = navigator.sendBeacon(FLOW_URL, blob);
        if (ok) return;
      } catch (e) { /* fallthrough */ }
      try {
        await fetch(FLOW_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) });
      } catch (e) { /* tyst */ }
    }

    f.addEventListener('submit', async (e) => {
      e.preventDefault();
      const reg = (document.getElementById('reg').value || '').trim();
      const skick = (new FormData(f)).get('skick');
      if(!reg || !skick) return;

      const btn = f.querySelector('button');
      btn.disabled = true;

      await sendToFlow({ regnr: reg, skick });

      chat.innerHTML = '';
      addMsg(`Skickat: ${reg} – ${skick}`, 'me');
      startPolling(reg);

      btn.disabled = false;
    });

    function addMsg(txt, who='sys', meta='') {
      const d = document.createElement('div');
      d.className = `msg ${who==='me'?'me':'sys'}`;
      d.innerHTML = txt.replace(/\n/g,'<br/>');
      chat.appendChild(d);
      if(meta){
        const m = document.createElement('div');
        m.className = 'meta';
        m.textContent = meta;
        chat.appendChild(m);
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function startPolling(reg) {
      if(pollTimer) clearInterval(pollTimer);
      fetchAndRender(reg); // direkt
      pollTimer = setInterval(() => fetchAndRender(reg), 10000); // var 10:e sekund
    }

    async function fetchAndRender(reg) {
      const q = encodeURIComponent(`repo:${GH_OWNER}/${GH_REPO} "${reg}" in:title state:open type:issue`);
      const url = `https://api.github.com/search/issues?q=${q}&per_page=1`;
      try {
        const r = await fetch(url);
        if(!r.ok) return;
        const data = await r.json();
        if(!data.items || !data.items.length) return;

        const issue = data.items[0];
        const number = issue.number;

        chat.innerHTML = '';
        addMsg(`Ärende öppnat för <span class="pill">${reg}</span>`, 'sys');
        if(issue.body){
          addMsg(issue.body, 'sys', `Issue #${number}`);
        }

        const rc = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${number}/comments`);
        if(!rc.ok) return;
        const comments = await rc.json();
        for(const c of comments){
          const ts = c.created_at ? new Date(c.created_at).toLocaleString() : '';
          addMsg(c.body || '', 'sys', ts);
        }
      } catch(e) {}
    }
  </script>
</body>
</html>
